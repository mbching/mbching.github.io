<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>)#ôë1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --text: #f0f0f0;
      --accent: #959595;
      --highlight: #1976d2;
    }

    body.light {
      --bg: #f5f5f5;
      --card: #ffffff;
      --text: #000000;
      --accent: #1976d2;
      --highlight: #0d47a1;
    }

    body {
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      padding: 10px 20px;
      background: var(--card);
    }

    .toggle-btn {
      background: var(--accent);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .toggle-btn:hover {
      background: var(--highlight);
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
    }

    .column {
      flex: 1 1 300px;
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    h2 {
      color: var(--accent);
      margin-top: 0;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <button class="toggle-btn" onclick="toggleTheme()">< Û;L</button>
  </div>

  <div class="container">
    <div class="column">
      <h2><$ ]))#1</h2>
      <ul id="weather-forecast"><li>	e-...</li></ul>
    </div>

    <div class="column">
      <h2>=Œ Citybus Route 5X</h2>
      <ul id="eta-5x"><li>Loading...</li></ul>    

      <h2>=Œ Route 102 (KMB + CTB)</h2>
      <ul id="eta-102"><li>Loading...</li></ul>

      <h2>=Œ Route 106 (KMB + CTB)</h2>
      <ul id="eta-106"><li>Loading...</li></ul>

      <h2>=Œ Route 103 (KMB + CTB)</h2>
      <ul id="eta-103"><li>Loading...</li></ul>

      <h2>=Œ Route 170 (KMB + CTB)</h2>
      <ul id="eta-170"><li>Loading...</li></ul>
    </div>
  </div>

  <script>
    function formatTime(iso) {
      if (!iso) return "No ETA";
      const date = new Date(iso);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

async function loadWeather() {
  try {
    const res = await fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=fnd&lang=tc");
    const data = await res.json();
    const forecast = data.weatherForecast;
    const list = document.getElementById("weather-forecast");
    list.innerHTML = "";

    forecast.forEach(day => {
      const li = document.createElement("li");
      li.textContent = `${day.forecastDate.slice(4,6)}${day.forecastDate.slice(6)}å - ${day.forecastWeather} <! ${day.forecastMintemp.value}°C - ${day.forecastMaxtemp.value}°C =§${day.forecastMinrh.value}%${day.forecastMaxrh.value}% <' Mè_${day.PSR}`;
      list.appendChild(li);
    });
  } catch (e) {
    document.getElementById("weather-forecast").innerHTML = "<li>)#Ç™	e1W</li>";
  }
}

    async function loadKMB102() {
      try {
        const res = await fetch("https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/13C75FFFA2BB060D");
        const json = await res.json();
        return json.data.filter(item => item.route === "102" && item.eta).map(item => ({
          eta: item.eta, dest: item.dest_en, company: "KMB"
        }));
      } catch {
        return [];
      }
    }

    async function loadCTB102() {
      try {
        const res = await fetch("https://rt.data.gov.hk/v2/transport/citybus/eta/CTB/001251/102");
        const json = await res.json();
        return json.data.filter(item => item.route === "102" && item.eta).map(item => ({
          eta: item.eta, dest: item.dest_en, company: "CTB"
        }));
      } catch {
        return [];
      }
    }

    async function loadCTB5X() {
      try {
        const res = await fetch("https://rt.data.gov.hk/v2/transport/citybus/eta/CTB/001342/5X");
        const json = await res.json();
        const list = document.getElementById('eta-5x');
        list.innerHTML = '';
        const buses = json.data.filter(item => item.route === "5X" && item.eta);
        if (buses.length === 0) {
          list.innerHTML = "<li>No data available for route 5X.</li>";
          return;
        }
        buses.forEach(bus => {
          const li = document.createElement("li");
          li.textContent = `ETA: ${formatTime(bus.eta)} ’ ${bus.dest_en || ''}`;
          list.appendChild(li);
        });
      } catch {
        document.getElementById('eta-5x').innerHTML = "<li>Error loading 5X ETA.</li>";
      }
    }

    async function loadRoute102Combined() {
      const list = document.getElementById('eta-102');
      list.innerHTML = "<li>Loading...</li>";
      const [kmbData, ctbData] = await Promise.all([loadKMB102(), loadCTB102()]);
      const allData = [...kmbData, ...ctbData].sort((a, b) => new Date(a.eta) - new Date(b.eta));
      list.innerHTML = '';
      if (allData.length === 0) {
        list.innerHTML = "<li>No ETA available for Route 102.</li>";
        return;
      }
      allData.forEach(bus => {
        const li = document.createElement("li");
        li.textContent = `[${bus.company}] ETA: ${formatTime(bus.eta)} ’ ${bus.dest}`;
        list.appendChild(li);
      });
    }

    async function loadCombinedRoute(route, kmbStopId, ctbStopId, containerId) {
      const list = document.getElementById(containerId);
      list.innerHTML = "<li>Loading...</li>";

      try {
        const [kmbRes, ctbRes] = await Promise.all([
          fetch(`https://data.etabus.gov.hk/v1/transport/kmb/eta/${kmbStopId}/${route}/1`).then(res => res.json()),
          fetch(`https://rt.data.gov.hk/v2/transport/citybus/eta/CTB/${ctbStopId}/${route}`).then(res => res.json())
        ]);

        const kmbData = (kmbRes.data || []).filter(i => i.eta).map(i => ({
          eta: i.eta, dest: i.dest_en, company: "KMB"
        }));

        const ctbData = (ctbRes.data || []).filter(i => i.eta).map(i => ({
          eta: i.eta, dest: i.dest_en, company: "CTB"
        }));

        const allData = [...kmbData, ...ctbData].sort((a, b) => new Date(a.eta) - new Date(b.eta));
        list.innerHTML = '';

        if (allData.length === 0) {
          list.innerHTML = `<li>No ETA available for Route ${route}.</li>`;
          return;
        }

        allData.forEach(bus => {
          const li = document.createElement("li");
          li.textContent = `[${bus.company}] ETA: ${formatTime(bus.eta)} ’ ${bus.dest}`;
          list.appendChild(li);
        });

      } catch {
        list.innerHTML = `<li>Error loading ETA for Route ${route}.</li>`;
      }
    }

    function refreshAll() {
      loadWeather();
      loadRoute102Combined();
      loadCTB5X();
      loadCombinedRoute("106", "31EA5920FFF0DBBF", "001251", "eta-106");
      loadCombinedRoute("103", "13C75FFFA2BB060D", "001251", "eta-103");
      loadCombinedRoute("170", "13C75FFFA2BB060D", "001251", "eta-170");
    }

    function toggleTheme() {
      document.body.classList.toggle("light");
      localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
    }

    (function() {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "light") {
        document.body.classList.add("light");
      }
    })();

    refreshAll();
    setInterval(refreshAll, 60000);
  </script>

</body>
</html>
