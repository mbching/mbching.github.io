<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤©æ°£èˆ‡å·´å£«åˆ°ç«™è³‡è¨Š</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-light: #f0f0f0;
      --bg-dark: #121212;
      --text-light: #333;
      --text-dark: #ddd;
      --title-grey: #777;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-light);
      margin: 0;
      padding: 20px;
      transition: all 0.3s ease;
    }

    body.dark {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    h2 {
      color: var(--title-grey);
      margin-top: 20px;
    }

    .section {
      margin-bottom: 40px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      background: white;
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 5px;
      font-family: monospace;
    }

    body.dark li {
      background: #1e1e1e;
    }

    .toggle-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      background: #444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 999;
    }

    .container {
      display: flex;
      flex-direction: row;
      gap: 20px;
      flex-wrap: wrap;
    }

    .weather-column, .bus-column {
      flex: 1 1 300px;
    }
  </style>
</head>
<body class="dark">

  <button class="toggle-btn" onclick="toggleTheme()">ğŸŒ— åˆ‡æ›ä¸»é¡Œ</button>

  <div class="container">
    <div class="weather-column section">
      <h2>ğŸŒ¦ï¸ ä¹å¤©å¤©æ°£é å ±</h2>
      <ul id="weather-forecast"><li>è¼‰å…¥ä¸­...</li></ul>
    </div>

    <div class="bus-column section">
      <h2>ğŸšŒ åŸå·´ 5X</h2>
      <ul id="eta-5x"><li>è¼‰å…¥ä¸­...</li></ul>

      <h2>ğŸšŒ è·¯ç·š 102ï¼ˆä¹å·´ + åŸå·´ï¼‰</h2>
      <ul id="eta-102"><li>è¼‰å…¥ä¸­...</li></ul>

      <h2>ğŸšŒ è·¯ç·š 106ï¼ˆä¹å·´ + åŸå·´ï¼‰</h2>
      <ul id="eta-106"><li>è¼‰å…¥ä¸­...</li></ul>

      <h2>ğŸšŒ è·¯ç·š 103ï¼ˆä¹å·´ + åŸå·´ï¼‰</h2>
      <ul id="eta-103"><li>è¼‰å…¥ä¸­...</li></ul>

      <h2>ğŸšŒ è·¯ç·š 170ï¼ˆä¹å·´ + åŸå·´ï¼‰</h2>
      <ul id="eta-170"><li>è¼‰å…¥ä¸­...</li></ul>
    </div>
  </div>

  <script>
    const formatTime = iso => iso ? new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "ç„¡è³‡æ–™";

    const busConfigs = [
      { id: '5x', ctb: '001342' },
      { id: '102', kmb: '13C75FFFA2BB060D', ctb: '001251' },
      { id: '106', kmb: '31EA5920FFF0DBBF', ctb: '001251' },
      { id: '103', kmb: '13C75FFFA2BB060D', ctb: '001251' },
      { id: '170', kmb: '13C75FFFA2BB060D', ctb: '001251' }
    ];

    async function fetchCTB(stopId, route) {
      const res = await fetch(`https://rt.data.gov.hk/v2/transport/citybus/eta/CTB/${stopId}/${route}`);
      const json = await res.json();
      return json.data.filter(b => b.eta).map(b => ({ eta: b.eta, dest: b.dest_tc, company: 'åŸå·´' }));
    }

    async function fetchKMB(stopId, route) {
      const res = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stopId}`);
      const json = await res.json();
      return json.data.filter(b => b.route === route && b.eta).map(b => ({ eta: b.eta, dest: b.dest_tc, company: 'ä¹å·´' }));
    }

    async function loadBusETAs() {
      for (const cfg of busConfigs) {
        const list = document.getElementById(`eta-${cfg.id}`);
        list.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';

        let etas = [];
        if (cfg.id === '5x') {
          etas = await fetchCTB(cfg.ctb, '5X');
        } else {
          const [kmbData, ctbData] = await Promise.all([
            fetchKMB(cfg.kmb, cfg.id),
            fetchCTB(cfg.ctb, cfg.id)
          ]);
          etas = [...kmbData, ...ctbData].sort((a, b) => new Date(a.eta) - new Date(b.eta));
        }

        list.innerHTML = '';
        if (!etas.length) {
          list.innerHTML = '<li>æ²’æœ‰åˆ°ç«™è³‡æ–™</li>';
        } else {
          etas.forEach(bus => {
            const li = document.createElement('li');
            li.textContent = `[${bus.company}] ${formatTime(bus.eta)} â†’ ${bus.dest}`;
            list.appendChild(li);
          });
        }
      }
    }

    async function loadWeather() {
      try {
        const res = await fetch("https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=fnd&lang=tc");
        const data = await res.json();
        const list = document.getElementById("weather-forecast");
        list.innerHTML = "";

        data.weatherForecast.forEach(day => {
          const date = `${day.forecastDate.slice(4, 6)}æœˆ${day.forecastDate.slice(6)}æ—¥`;
          const weather = day.forecastWeather;
          const temp = `ğŸŒ¡ï¸ ${day.forecastMintemp.value}Â°-${day.forecastMaxtemp.value}Â°C`;
          const rh = `ğŸ’§ ${day.forecastMinrh.value}-${day.forecastMaxrh.value}%`;
          const rain = `ğŸŒ§ï¸ è½é›¨æ©Ÿæœƒ: ${day.PSR}%`;

          const li = document.createElement("li");
          li.innerHTML = `ğŸ“… ${date}<br>${weather}<br>${temp}<br>${rh}<br>${rain}`;
          list.appendChild(li);
        });
      } catch {
        document.getElementById("weather-forecast").innerHTML = "<li>è¼‰å…¥å¤±æ•—</li>";
      }
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    loadWeather();
    loadBusETAs();
    setInterval(() => {
      loadWeather();
      loadBusETAs();
    }, 60000);
  </script>

</body>
</html>
